# CloudWatch Dashboard Configuration for Peppol SML/SMP Lookup Service
# Comprehensive operational dashboard with peppol-commons metrics

AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudWatch Dashboard for Peppol SML/SMP Lookup Service'

Parameters:
  FunctionName:
    Type: String
    Description: Name of the Lambda function
    Default: peppol-sml-smp-lookup
  
  Environment:
    Type: String
    Description: Environment (dev, test, production)
    Default: production

Resources:
  PeppolLookupDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "Peppol-Lookup-${Environment}"
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/Lambda", "Invocations", "FunctionName", "${FunctionName}" ],
                  [ ".", "Errors", ".", "." ],
                  [ ".", "Duration", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Lambda Function Overview",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "SuccessfulLookups" ],
                  [ ".", "FailedLookups" ],
                  [ ".", "ValidationFailures" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Business Metrics",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "SmlLookupTime" ],
                  [ ".", "SmpQueryTime" ],
                  [ ".", "CertificateValidationTime" ],
                  [ ".", "XmlSignatureValidationTime" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Performance Metrics (ms)",
                "period": 300,
                "stat": "Average"
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "ExternalServiceAvailability" ],
                  [ ".", "CircuitBreakerOpen" ],
                  [ ".", "RetryAttempts" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "External Service Health",
                "period": 300,
                "stat": "Average"
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "MemoryUtilization" ],
                  [ ".", "CpuUtilization" ],
                  [ ".", "ConnectionPoolUtilization" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Resource Utilization (%)",
                "period": 300,
                "stat": "Average"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "PeppolCommonsIdentifierValidations" ],
                  [ ".", "PeppolCommonsSmpClientCalls" ],
                  [ ".", "PeppolCommonsCertificateValidations" ],
                  [ ".", "PeppolCommonsErrors" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Peppol-Commons Library Metrics",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "CertificateExpiringWithin30Days" ],
                  [ ".", "CertificateExpiringWithin7Days" ],
                  [ ".", "RevokedCertificatesDetected" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Certificate Health Metrics",
                "period": 3600,
                "stat": "Maximum"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "SecurityEvents" ],
                  [ ".", "MaliciousInputsDetected" ],
                  [ ".", "XmlAttackAttempts" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Security Events",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "ErrorsByCategory", "Category", "SML" ],
                  [ "...", "SMP" ],
                  [ "...", "CERTIFICATE" ],
                  [ "...", "NETWORK" ],
                  [ "...", "VALIDATION" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Errors by Category",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Peppol/Lookup", "CacheHitRate" ],
                  [ ".", "CacheMissRate" ],
                  [ ".", "CacheEvictions" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Cache Performance",
                "period": 300,
                "stat": "Average"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 24,
              "width": 24,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${FunctionName}'\n| fields @timestamp, level, message, correlationId, participantId, errorCode\n| filter level = \"ERROR\"\n| sort @timestamp desc\n| limit 100",
                "region": "${AWS::Region}",
                "title": "Recent Errors",
                "view": "table"
              }
            }
          ]
        }

Outputs:
  DashboardUrl:
    Description: URL of the CloudWatch Dashboard
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=Peppol-Lookup-${Environment}"